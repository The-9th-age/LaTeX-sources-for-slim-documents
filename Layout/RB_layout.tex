\RequirePackage{amsmath}
\documentclass[a4paper,10pt]{article}

\usepackage[a4paper, top=2cm, bottom=2cm, left=2cm, right=2cm]{geometry} % Marge reduction.

%% Font and typing packages
\usepackage{fontspec}
\setmainfont[
	Ligatures=TeX,
	SmallCapsFont={Caladea}
	]{Caladea} % default is Latin Modern
%\setmainfont[Ligatures=TeX,SmallCapsFont={OpenDyslexic}]{OpenDyslexic} % default is Latin Modern

\newfontfamily\titlefont[Ligatures=TeX]{Georgia} % font for front page title
\usepackage{microtype}			% Greatly improves general appearance of the text.
\usepackage{siunitx}			% Unit appearance.
\sisetup{detect-all}				% Avoid using the math font in a normal text.
\usepackage{ulem}				% To cross words out. Use \sout{}.
\usepackage{anyfontsize}  % Disable the warnings when a font size isn't available.
\usepackage{unicode-math} % Math characters are copy pasted correctly

\ifdefined\languageisfrench
	%% Language specific package
	\usepackage[french]{babel}
	\frenchbsetup{StandardLists=true} % Necessary to use enumitem with babel/french.
\fi
\ifdefined\languageisenglish
	%% Language specific package
	\usepackage[super]{nth}
\fi
\ifdefined\languageisitalian
	%% Language specific package
	\usepackage[italian]{babel}
\fi
\ifdefined\languageisspanish
	%% Language specific package
	\usepackage[spanish]{babel}
\fi
\ifdefined\languageispolish
	%% Language specific package
	\usepackage[polish]{babel}
\fi
\ifdefined\languageisrussian
	%% Language specific package
	\usepackage[russian]{babel}
\fi
\ifdefined\languageisgerman
	%% Language specific package
	\usepackage[german]{babel}
	\usepackage[super]{nth}
\fi

%% Array utilities
\usepackage{booktabs} 		% for rules in arrays
\usepackage{pbox} 				% for linebreaks in arrays
\usepackage{array}				% Additionnal options for arrays.
\usepackage{colortbl}			% Additionnal options for coloring arrays.
\usepackage[table]{xcolor}		% Auto alternate grey-white rows. Xcolor must be loaded before mdframed.
\usepackage[export]{adjustbox}		% Centered pics in tables
\usepackage{diagbox}		% diagonal slash in a cell

%% List utilities
\usepackage[inline]{enumitem}   % Display inline lists.
\usepackage{etoolbox}           % General utility. Good for lists for instance.
\usepackage{xparse}             % List utilities.

%% Frames
\usepackage{framed}				% Boxes.
\usepackage[framemethod=TikZ]{mdframed}% For fancy frames.
\usepackage{tikz}				% For fancy frames.
\usepackage{wrapfig}			% Fancy insertion of pics in text.

%% Page utilities
\usepackage{refcount}			% extract number from page number
\usepackage{graphicx}        % for the \includegraphics command
\usepackage{parskip} 			% no paragraph indentation and spaces between paragraphs.
\usepackage{multicol}			% Allows to divide a part of the page in multiple columns.
\usepackage{titlesec} 			% titles customization
\usepackage{caption}			% captions customization
\captionsetup{singlelinecheck=off, labelfont=bf, textfont={color=black!60}}
\usepackage{float}				% Forces float in a specific position with H
\usepackage{fancyhdr}		% For custom headers and foot texts
\pagestyle{fancy}
\usepackage{csquotes}		% automatic quotation marks adapted of the current language. can be summoned with \enquote{X}

%% TOC
\usepackage{tocloft} % http://ctan.org/pkg/tocloft
\usepackage[toc]{multitoc}
	
%% Others
\usepackage{calc}
\usepackage{epstopdf}         % needed to use the .eps format in LuaTeX
\usepackage{xstring}            % String parsing, cutting, etc.
\definecolor{linkcolour}{RGB}{131,25,139}
\usepackage[unicode, colorlinks=true, linkcolor=linkcolour, urlcolor=linkcolour, bookmarks=false, pdfdisplaydoctitle=true, pdfstartview=FitH, pdfpagelabels=true]{hyperref} % Links in PDF.
\usepackage[ocgcolorlinks]{ocgx2}

\graphicspath{{./pics/}{./../Layout/pics/}}

\makeatletter

%%% Language specific stuff

\input{../Layout/language_specific_files.tex}

\def\removespaces#1{\zap@space#1 \@empty}

\pdfstringdefDisableCommands{\def\textcolor#1{}}


%%% Technical commands %%%

% Necessary for AB_language_specific
\newcommand{\ifsubstring}[4]{%
\protected@edef\split@temp{#1}%
\protected@edef\split@tempbis{#2}%
\saveexpandmode%
\expandarg\IfSubStr{\split@temp}{\split@tempbis}{#3}{#4}%
\restoreexpandmode%
}

\newcommand{\isitoneornot}[3]{%
% First step is to remove spaces if there are some
\def\numberwithoutspaces{\expandafter\removespaces\expandafter{#1}}%
% Next step is getting rid of formatting if there are any (bold, color, ...)
\pdfstringdef\cleannumber{\numberwithoutspaces}%
%Defining 1 in \pdfstringdef terms (it will add \376\377\000 before usually - unicode identifier)
\pdfstringdef\numberone{1}%
% Now we can try if it is 1 or not
\ifsubstring{\numberone}{\cleannumber}{#2}{#3}%
}

\newcommand{\isthereaplusornot}[3]{%
\ifsubstring{#1}{+}{#2}{#3}%
}

\def\removespaces#1{\zap@space#1 \@empty}

\newenvironment{hidewhenprinted}{\begin{ocg}[printocg=never]{HideWhenPrinted}{id1}{1}}{\end{ocg}}

\newcommand{\debugfooter}{\hfill\textcolor{white}{debug}}

% Others
\newcommand{\greycolor}{black!50}
\newcommand{\greytextcolor}{\textcolor{\greycolor}}
\newcommand{\newrule}{\textcolor{blue!80!black}}
\newcommand{\protectednewrule}{\textcolor{blue!80!black}}
\newcommand{\removedrule}[1]{\textcolor{blue!80!black}{\sout{#1}}}
\newcommand{\rewordedrule}{\textcolor{green!60!black}}
\newcommand{\removedreworded}[1]{\textcolor{green!60!black}{\sout{#1}}}
\newcommand{\protectedrewordedrule}{\textcolor{green!80!black}}
\newcommand{\starsymbol}{$\star$}
\newcommand{\refsymbol}{$^\star$}
\newcommand{\flufffont}[1]{\textit{#1}}

\DeclareSIUnit[number-unit-product = {}]{\inch}{″}
\DeclareSIUnit[number-unit-product = {}]{\foot}{′}
\newcommand{\range}[1] {\labels@range~#1\si{\inch}}
\newcommand{\distance}[1] {#1\si{\inch}}
\newcommand{\result}[1] {‘#1’}
\newcommand{\plusone}{+1}

\newcommand{\captionpar}{\vspace*{10pt}\newline}
\newcommand{\captionlist}{\vspace*{3pt}\newline}
\newcommand{\captionitem}{\hspace*{0.3cm}}

\newcommand{\pts}[1]{#1~\labels@points}

\newcommand{\predotfill}{\penalty0\hbox{}\nobreak}

%%% Fonts and sizes %%%

\newcommand{\verysmallfontsize}{\fontsize{4}{4.8}\selectfont}
\newcommand{\smallfontsize}{\fontsize{6}{7.2}\selectfont}
\newcommand{\normalfontsize}{\fontsize{8}{9.6}\selectfont}
\newcommand{\largefontsize}{\fontsize{10}{12}\selectfont}
\newcommand{\largerfontsize}{\fontsize{12}{14.4}\selectfont}
\newcommand{\Largefontsize}{\fontsize{14}{16.8}\selectfont}
\newcommand{\Largerfontsize}{\fontsize{15}{18}\selectfont}
\newcommand{\hugefontsize}{\fontsize{18}{21.6}\selectfont}
\newcommand{\Hugefontsize}{\fontsize{25}{30}\selectfont}


%%% Headers %%%

\renewcommand{\headrulewidth}{0pt}
\fancyfoot[R]{%
\strut\begin{hidewhenprinted}\hyperlink{specialrulestable}{%
\normalfontsize\specialrulesfooter%
} \hspace{1cm} \hyperref[summaries]{%
\normalfontsize\summariesfooter%
}\end{hidewhenprinted}%
}
\fancyfoot[L]{%
\strut\begin{hidewhenprinted}\hyperlink{toc}{%
\normalfontsize\tableofcontentsfooter%
}\end{hidewhenprinted}%
}
\fancyhead[R]{}
\fancyhead[L]{}

%%% Page formatting

\newcommand{\spaceaftersection}{\vspace{0.8cm}}

\newcommand{\separator}{\noindent\begin{center}\textcolor{\greycolor}{\rule{0.7\columnwidth}{2pt}}\end{center}}

\def\columnseprulecolor{\color{\greycolor}}


%%% Custom lists and description for first sections of the army books

\setlength{\columnsep}{1cm}

\newcommand{\startpricelist}{\raggedcolumns\begin{multicols}{2}\begin{description}[leftmargin=0.3cm, labelindent=0cm, labelsep=0.1cm, itemsep=8pt]}
\def\endpricelist{\end{description}\end{multicols}}
\newcommand{\pricelistitem}[3]{\item \begin{samepage}\textbf{#1}\predotfill\hfill\nobreak\pts{#2}\newline{#3}\end{samepage}\par}
\newcommand{\nopricelistitem}[1]{\item \textbf{#1}\newline}

\newcommand{\itemrestriction}[1]{\textcolor{\greycolor}{#1}\vspace*{3pt}\newline}

%%% Table parameters %%%

\newcolumntype{M}[1]{>{\centering\let\newline\\\arraybackslash\hspace{0pt}}m{#1}}
\newcolumntype{P}[1]{>{\centering\let\newline\\\arraybackslash\hspace{0pt}}p{#1}}

\newcommand{\specialcell}[2][c]{%
  \begin{tabular}[#1]{@{}c@{}}#2\end{tabular}}
  
\renewcommand{\arraystretch}{1.5}
\arrayrulecolor{\greycolor}
\setlength{\arrayrulewidth}{0.5pt}

\newenvironment{tableterrain}%
               {\noindent\begin{tabular}{>{\bfseries\raggedleft}p{2.2cm}p{13.5cm}}}
               {\end{tabular}}

%%% Frames %%%

\newmdenv[linewidth=0pt,nobreak,innertopmargin=-10pt,backgroundcolor=black!5,roundcorner=10pt]{optionalrules}

%%% Titles %%%

\titleformat{\part}[block]{\Hugefontsize\bfseries\filcenter}{\thepart}{1em}{}
\renewcommand{\thepart}{\textcolor{black!60}{\arabic{part}}}
\renewcommand{\thesection}{\thepart\textcolor{black!60}{.\Alph{section}}}
\renewcommand{\thesubsection}{%
\ifnum\value{section}=0%
	\thepart\textcolor{black!60}{.\alph{subsection}}%
\else%
	\thesection\textcolor{black!60}{.\alph{subsection}}%
\fi}
\renewcommand{\thesubsubsection}{%
\ifnum\value{section}=0%
	\ifnum\value{subsection}=0%
		\thepart\textcolor{black!60}{.\arabic{subsubsection}}%
	\else%
		\thepart\textcolor{black!60}{.\alph{subsection}.\arabic{subsubsection}}%
	\fi%
\else%
	\ifnum\value{subsection}=0%
		\thesection\textcolor{black!60}{.\arabic{subsubsection}}%
	\else%
		\thesection\textcolor{black!60}{.\alph{subsection}.\arabic{subsubsection}}%
	\fi%
\fi}
\makeatletter\@addtoreset{section}{part}

\titleformat{\subsubsection}{\normalfont\normalsize\bfseries}{\thesubsubsection}{1em}{}
\titlespacing*{\subsubsection}{0pt}{2.5ex plus 1ex minus .2ex}{0.5ex plus .2ex}

\titleformat{\paragraph}{\normalfont\normalsize\bfseries}{\thesubsubsection}{1em}{}
\titlespacing*{\paragraph}{0pt}{2.5ex plus 1ex minus .2ex}{0.5ex plus .2ex}

\newcommand{\totalref}[1]{\ref{#1} \enquote{\nameref{#1}}, \pageforref{} \pageref{#1}}% \autoref*{#1} for ref + name of the part.
%Debugging part name not being updated correctly for ref
\makeatletter
\let\oldpart\part
\def\part#1{\def\@currentlabelname{#1}\oldpart{#1}}

%%% Model Rules %%%

\newcounter{specialruletablepagecounter}

\newcommand{\specialruletableentry}[2]{\hyperref[#1]{#2}%
\ifnum\getpagerefnumber{#1}>\value{specialruletablepagecounter}%
\hfill\pageref{#1}%
\setcounter{specialruletablepagecounter}{\getpagerefnumber{#1}}%
\fi\newline}

\newcommand{\specialruletablesubtitle}[2]{\hyperref[#1]{\textbf{#2}}%
\hfill\textbf{\pageref{#1}}\\[5pt]%
\setcounter{specialruletablepagecounter}{\getpagerefnumber{#1}}%
}


%%% TOC %%%

\renewcommand{\cfttoctitlefont}{\hspace*{\fill}\Hugefontsize\bfseries\centering}
\renewcommand{\cftaftertoctitle}{\hspace*{\fill}\vspace*{10pt}}
\setlength{\cftsecnumwidth}{2em} % Set length of number width in ToC for sections
\setlength{\cftbeforepartskip}{1.5em} % small blank before parts in ToC
\renewcommand{\cftpartafterpnum}{\vspace*{-7pt}\par\protect\mbox{}\protect\greytextcolor{\hrulefill}\vspace*{3pt}\par}
\setlength{\cftbeforesecskip}{0em} % no blank before sections in ToC
\renewcommand{\cftpartfont}{\largefontsize\bfseries} % parts text: right aligned and bold
\renewcommand{\cftpartpagefont}{\largefontsize\bfseries} % parts page number: bold
%\renewcommand{\cftpartleader}{} % no dots between text and page numbers
\renewcommand{\cftsecfont}{\normalfontsize} % sections text: right aligned and smaller
\renewcommand{\cftsecpagefont}{\normalfontsize} % sections page numbers: smaller
%\renewcommand{\cftsecleader}{} % no dots between text and page numbers
\renewcommand\numberline[1]{} % remove section numbers: just leave text + page number
\cftsetindents{section}{1em}{0em} % reduce margins
\cftsetindents{part}{0em}{0em} % reduce margins
\makeatletter\cftsetrmarg{\@pnumwidth} % align the titles that are on 2 lines on the page numbers
\setcounter{tocdepth}{1} % only display parts and sections, not below

\renewcommand*{\multicolumntoc}{3} % table of contents on 3 columns

%%% TOC with everything

%\renewcommand{\cfttoctitlefont}{\hspace*{\fill}\Hugefontsize\bfseries\centering}
%\renewcommand{\cftaftertoctitle}{\hspace*{\fill}\vspace*{10pt}}
%\setlength{\cftbeforepartskip}{0em} % small blank before parts in ToC
%\setlength{\cftbeforesecskip}{0em} % no blank before sections in ToC
%\setlength{\cftbeforesubsecskip}{0em} % no blank before sections in ToC
%\setlength{\cftbeforeparaskip}{0em} % no blank before sections in ToC
%\renewcommand{\cftdotsep}{\cftnodots} % no dots between text and page numbers
%\cftsetindents{section}{0.5em}{2.5em} % reduce margins
%\cftsetindents{subsection}{1em}{3em} % reduce margins
%\cftsetindents{paragraph}{1.5em}{3em} % reduce margins
%\cftsetindents{part}{0em}{0em} % reduce margins
%\renewcommand{\cftsubsecfont}{\normalfontsize}
%\renewcommand{\cftparafont}{\normalfontsize}
%\makeatletter\cftsetrmarg{\@pnumwidth} % align the titles that are on 2 lines on the page numbers
%\setcounter{tocdepth}{4} % only display parts and sections, not below
%
%\renewcommand*{\multicolumntoc}{2} % table of contents on 3 columns
