
%%% restrictions commands %%%

\newcommand{\itemrestriction}[1]{\greytextcolor{#1}\newline}%
\newcommand{\itemrestrictionnopar}[1]{\greytextcolor{#1}\newline}% deprecated
\newcommand{\itemrestrictionblack}[1]{#1\newline}%
\newcommand{\enchantmentrestriction}[1]{\Enchantment{}\spacebeforecolon{}: #1.\newline}


%%% Input parameters %%%

\define@key{item}{type}{\def\item@type{#1}}
\define@key{item}{name}{\def\item@name{#1}}
\define@key{item}{cost}{\def\item@cost{#1}}
\define@key{item}{enchantment}{\def\item@enchantment{#1}}
\define@key{item}{maxnumber}{\def\item@maxnumber{#1}}
\define@key{item}{dominant}{\def\item@dominant{#1}}
\define@key{item}{restriction}{\def\item@restriction{#1}}
\define@key{item}{rules}{\def\item@rules{#1}}

\define@key{item}{guidingdominant}{\def\item@guidingdominant{#1}}


%%% Command to add a new item definition %%%

\newcommand{\defitem}{
	\setkeys{item}{%
		type=, name=, cost=, enchantment=, maxnumber=, dominant=, restriction=, rules=, guidingdominant=,
	}%
	\setkeys{item}%
}


%%% The Command %%%

\newcommand{\itementry}[1]{%
	\defitem{#1}%	
	% Mimicing \sortedpricelistitem, can't use it directly because of expansion problems, and need to add a few other entries
	\DTLnewrow{sortedpricelist}%
	\def\DTLentrycommand{\DTLnewdbentry{sortedpricelist}{name}}%
	\expandafter\DTLentrycommand\expandafter{\item@name}%
	\def\DTLentrycommand{\DTLnewdbentry{sortedpricelist}{cost}}%
	\expandafter\DTLentrycommand\expandafter{\item@cost}%
	\def\DTLentrycommand{\DTLnewdbentry{sortedpricelist}{ruletext}}%
	\expandafter\DTLentrycommand\expandafter{\item@rules}%
	\def\DTLentrycommand{\DTLnewdbentry{sortedpricelist}{enchantment}}%
	\expandafter\DTLentrycommand\expandafter{\item@enchantment}%
	\def\DTLentrycommand{\DTLnewdbentry{sortedpricelist}{maxnumber}}%
	\expandafter\DTLentrycommand\expandafter{\item@maxnumber}%
	\def\DTLentrycommand{\DTLnewdbentry{sortedpricelist}{dominant}}%
	\expandafter\DTLentrycommand\expandafter{\item@dominant}%
	\def\DTLentrycommand{\DTLnewdbentry{sortedpricelist}{restriction}}%
	\expandafter\DTLentrycommand\expandafter{\item@restriction}%
	\def\DTLentrycommand{\DTLnewdbentry{sortedpricelist}{guidingdominant}}%
	\expandafter\DTLentrycommand\expandafter{\item@guidingdominant}%
	\pdfstringdef\textwithoutformatting{\item@name}%
	\pdfsubstitute\textwithoutformatting{'}{}%
	\pdfsubstitute\textwithoutformatting{ }{}%
	\dolanguagespecificsubstitute{}%
	\def\DTLentrycommand{\DTLnewdbentry{sortedpricelist}{sortlabel}}%
	\expandafter\DTLentrycommand\expandafter{\textwithoutformatting}%
	\pdfstringdef\costwithoutformatting{\item@cost}%
	\pdfsubstitute\costwithoutformatting{ }{}%
	\pdfsubstitute\costwithoutformatting{\free}{0}%
	\pdfsubstitute\costwithoutformatting{\nolimit}{999999}%
	\substitute\costwithoutformatting{\string\376}{}%
	\substitute\costwithoutformatting{\string\377}{}%
	\substitute\costwithoutformatting{\string\000}{}%
	\def\DTLentrycommand{\DTLnewdbentry{sortedpricelist}{costsortlabel}}%
	\expandafter\DTLentrycommand\expandafter{\costwithoutformatting}%
	\def\temphypertag{}%
	\StrGobbleRight{\expandafter\expandafter\expandafter\@gobble\expandafter\string\item@name}{1}[\temphypertag] % remove first the \ to the left and then the {} to the right - it counts as 1 character and then bug the hyperlink tag. It will remove the last character of the macro name if there is no {} in the end of the name key. So it should always be input as "name=\fancyunitname{},". "name=\fancyunitname," will make hyperlinks crash.
	\xdef\SPLitemhypertag{\temphypertag}% using the unit name macro to define an hypertag
	\def\DTLentrycommand{\DTLnewdbentry{sortedpricelist}{itemhypertag}}%
	\expandafter\DTLentrycommand\expandafter{\SPLitemhypertag}%
}
