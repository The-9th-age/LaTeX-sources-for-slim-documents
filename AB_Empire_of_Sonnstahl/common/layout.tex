%% GENERIC CODES


%%%%%%%%%%%%%
%CUSTOM UNIT LAYOUTS
%%%%%%%%%%%%%
%UNIT ENTRY BASE SIZE: see mount % Used to solve the EoS KN_CDR unit base size display
%%%%%%%%%%%%%
\newcommand{\unitentrynobase}[1]{%
\def\@minipagerestore{\setlength{\parskip}{\mycurrentparskip}}% Else paragraph and title spaces behave differently when inside or outside a minipage - Unit entry spacing has been coded with this in mind, if you remove it, all spaces will be off
\defunit{#1}%
%
\begin{minipage}[t]{\textwidth}% To avoid splitted profiles between 2 pages
%
%%%%%%%%%%%%%%%%%%%%%%
% Unit title, logos and general info
%
\def\temphypertag{}
\StrGobbleRight{\expandafter\expandafter\expandafter\@gobble\expandafter\string\unit@name}{1}[\temphypertag] % remove first the \ to the left and then the {} to the right - it counts as 1 character and then bug the hyperlink tag. It will remove the last character of the macro name if there is no {} in the end of the name key. So it should always be input as "name=\fancyunitname{},". "name=\fancyunitname," will make hyperlinks crash.
\xdef\unithypertag{\bookprefix\arabic{categorynumber}\temphypertag}% using the unit name macro to define an hypertag
\hypertarget{\unithypertag}{}%
\rule{\textwidth}{0.5pt}\par\vspace{-5pt}%
{%
% Logos
\hspace*{-3pt}\expandafter\ifblank\expandafter{\unit@secondlogo}{%
\begin{minipage}[b]{0.08\textwidth}%
\expandafter\ifblank\expandafter{\unit@speciallogo}{%
\includegraphics[width=\textwidth]{{logo_\unit@logo}.png}%
}{\begin{center}\includegraphics[width=0.7\textwidth]{\unit@speciallogo}\end{center}}%
\vspace*{-4pt}%
}{%
\begin{minipage}[b]{0.16\textwidth}%
\includegraphics[width=0.5\textwidth]{{logo_\unit@logo}.png}%
\includegraphics[width=0.5\textwidth]{{logo_\unit@secondlogo}.png}%
\vspace*{-4pt}%
}%
\end{minipage}%
%
% Title, unit cost and size
\setlength{\lengthbeforemodelsizetwologos}{\lengthbeforemodelsize - 0.08\textwidth}
\expandafter\ifblank\expandafter{\unit@secondlogo}{%
\hspace{0.01\textwidth}\begin{minipage}[b]{0.5\textwidth+3pt}%
}{%
\hspace{0.01\textwidth}\begin{minipage}[b]{0.42\textwidth+3pt}%
\renewcommand{\perextramodel}{\perextramodelshortened}%
\setlength{\lengthbeforemodelsize}{\lengthbeforemodelsizetwologos}%
}%
% Title with hyperlink, scoring logo
{\Largerfontsize\textbf{\unit@name}}%
\vspace*{3pt}\newline%
% Unit cost and size
\expandafter\ifblank\expandafter{\unit@cost}{}{{\largerfontsize\pts{\textbf{\unit@cost}}} }%
% Is it a single model or a unit with multiple models?
\expandafter\ifblank\expandafter{\unit@unitsize}{}{% if there is no unitsize, we don't print anything at all
	% Now we want to see if there is 1 or more models
	\isitoneornot{\unit@unitsize}{% 1 model
		% Can you add models?
		\expandafter\ifblank\expandafter{\unit@costpermodel}{% no other models
			\hspace*{\lengthbeforemodelsize}%
			\setlength{\lengthoftheptsblock}{\widthof{{\largerfontsize\pts{\textbf{\unit@cost}}} }}%		
			\hspace*{-\lengthoftheptsblock}%
			\singlemodel{}%
		}{% possibility of more models
			+ \pts{\textbf{\unit@costpermodel}}\perextramodel{}%
			%
			\hspace*{\lengthbeforemodelsize}%
			\setlength{\lengthoftheptsblock}{\widthof{{\largerfontsize\pts{\textbf{\unit@cost}}} + \pts{\textbf{\unit@costpermodel}}\perextramodel{}}}%		
			\hspace*{-\lengthoftheptsblock}%
			\textbf{1--\unit@maxunitsize} \Models{}%
		}%
	}{% more than 1 model
		+ \pts{\textbf{\unit@costpermodel}}\perextramodel{}%
		%
		\hspace*{\lengthbeforemodelsize}%
		\setlength{\lengthoftheptsblock}{\widthof{{\largerfontsize\pts{\textbf{\unit@cost}}} + \pts{\textbf{\unit@costpermodel}}\perextramodel{}}}%		
		\hspace*{-\lengthoftheptsblock}%
		\textbf{\unit@unitsize{}--\unit@maxunitsize} \Models{}%
	}%
}%
\vspace{0pt}%
\end{minipage}%
%
% Restrictions
\hfill\begin{minipage}[b]{0.2\textwidth}%
\setlength{\parskip}{0pt}%
\begin{center}%
% Count the number of restrictions
\setcounter{numberofrestrictions}{0}% reset
\expandafter\ifblank\expandafter{\unit@maxunitsperarmy}{}{\stepcounter{numberofrestrictions}}%
\expandafter\ifblank\expandafter{\unit@maxmountsperarmy}{}{\stepcounter{numberofrestrictions}}%
\expandafter\ifblank\expandafter{\unit@maxmodelsperarmy}{}{\stepcounter{numberofrestrictions}}%
\expandafter\ifblank\expandafter{\unit@addrestriction}{}{\stepcounter{numberofrestrictions}}%
\expandafter\ifstrequal\expandafter{\unit@scoring}{yes}{%
	\ifnumcomp{\value{numberofrestrictions}}{>}{1}{%
		\strut\includegraphics[height=8pt]{logo_scoring.png}\par%
	}{%
		\ifnumcomp{\value{numberofrestrictions}}{=}{0}{%
			\strut\vspace*{6pt}\includegraphics[height=12pt]{logo_scoring.png}\par%
		}{%
			\strut\includegraphics[height=12pt]{logo_scoring.png}\par%
		}%
	}%
}{}%
\expandafter\ifblank\expandafter{\unit@maxunitsperarmy}{}{%
\zerotoXunitsperarmy{\unit@maxunitsperarmy}\par%
}%
\expandafter\ifblank\expandafter{\unit@maxmountsperarmy}{}{%
\zerotoXmountsperarmy{\unit@maxmountsperarmy}\par%
}%
\expandafter\ifblank\expandafter{\unit@maxmodelsperarmy}{}{%
\zerotoXmodelsperarmy{\unit@maxmodelsperarmy}\par%
}%
\expandafter\ifblank\expandafter{\unit@addrestriction}{}{%
\unit@addrestriction%
}%
\end{center}%
\vspace{0pt}%
\end{minipage}%
%
% Size, Type and Base
\begin{minipage}[b]{0.2\textwidth}%
\renewcommand{\arraystretch}{1}%
\begin{tabular}{@{}>{\raggedleft}p{0.25\textwidth}@{\hskip 0.03\textwidth}p{0.72\textwidth}@{}}%
\ChLab{\size}&\unit@size{}\tabularnewline%
\ChLab{\type}&\unit@type{}\tabularnewline%
\ChLab{\basesize}&\unit@basesize{} \seemount% USED FOR Kn CDR OUTPUT
\end{tabular}%
\vspace*{-4pt}%
\end{minipage}\par%
}%
\vspace{-10pt}\rule{\textwidth}{0.5pt}\par%
%
% Category note and optional logo
\expandafter\ifblank\expandafter{\unit@optionallogo}{% no logo
\expandafter\ifblank\expandafter{\unit@categorynote}{}{%
\vspace*{-4pt}\textit{\unit@categorynote}\par%
\vspace*{-10pt}\rule{\textwidth}{0.5pt}\par%
}%
}{% with logo
\vspace*{-7pt}\hspace*{-3pt}\begin{tabular}{@{}m{0.06\textwidth}@{}m{0.9\textwidth}@{}}%
\includegraphics[width=0.06\textwidth]{{logo_\unit@optionallogo}.png}&%
\textit{\unit@categorynote}\tabularnewline%
\end{tabular}\par%
\vspace*{-10pt}\rule{\textwidth}{0.5pt}\par%
}%
%%%%%%%%%%%%%%%%%%%%%%
% Characteristics and rules
%%%%%%%%%%%%%%%%%%%%%%
% Global Characteristics
\renewcommand{\arraystretch}{1.4}%
\vspace*{-7pt}%
\startcharacteristicstable{}%
\hspace*{3pt}{\ChLab{\GlobalCharacteristics}}&%
{\ChLab{\AdvanceRateInitials}}&%
{\ChLab{\MarchRateInitials}}&%
{\ChLab{\DisciplineInitials}}&%
\expandafter\ifblank\expandafter{\unit@global@Rsr}{}{{\ChLab{\resurrectedInitials}}}&%
&%
\ChLab{\ModelRules}\tabularnewline%
\expandafter\ifblank\expandafter{\unit@global@Adfly}{}{%
\raggedleft\setlength{\parskip}{0pt}%
\ChLab{\groundmovementlabel}\par%
\ChLab{\flymovementlabel}%
}%
&%
\expandafter\ifblank\expandafter{\unit@global@Ad}{-}{%
\ifsubstring{\unit@global@Ad}{\ascharacter}{\ChVal{{\unit@global@Ad}}}{\ChVal{\distance{\unit@global@Ad}}}%
}%
\expandafter\ifblank\expandafter{\unit@global@Adfly}{}{\setlength{\parskip}{0pt}\par\ChVal{\distance{\unit@global@Adfly}}}%
&%
\expandafter\ifblank\expandafter{\unit@global@Ma}{-}{%
\ifsubstring{\unit@global@Ma}{\ascharacter}{\ChVal{{\unit@global@Ma}}}{\ChVal{\distance{\unit@global@Ma}}}%
}%
\expandafter\ifblank\expandafter{\unit@global@Mafly}{}{\setlength{\parskip}{0pt}\par\ChVal{\distance{\unit@global@Mafly}}}%
&%
\expandafter\ifblank\expandafter{\unit@global@Di}{-}{\ChVal{\unit@global@Di}}&%
\expandafter\ifblank\expandafter{\unit@global@Rsr}{}{\ChVal{\unit@global@Rsr}}&%
&%
\strut\expandafter\ifblank\expandafter{\unit@globalrules}{}{\alphaorderlist{\unit@globalrules}}%
\tabularnewline%
\end{tabular}%

%%%%%%%%%%%%%%%%%%%%%%
% Defensive Characteristics
\vspace*{-7pt}%
\startcharacteristicstable{}%
\hspace*{3pt}\ChLab{\DefensiveCharacteristics{}}&%
{\ChLab{\HealthPointsInitials}}&%
{\ChLab{\DefensiveSkillInitials}}&%
{\ChLab{\ResilienceInitials}}& %
{\ChLab{\ArmourInitials}}&%
\expandafter\ifblank\expandafter{\unit@printAeg}{%
	\expandafter\ifblank\expandafter{\unit@defense@Aeg}{}{\ChLab{\AegisInitials}}%
}{\ChLab{\AegisInitials}}&%
\tabularnewline%
&% no defensive name
\expandafter\ifblank\expandafter{\unit@defense@HP}{-}{\ChVal{\unit@defense@HP}}&%
\expandafter\ifblank\expandafter{\unit@defense@Df}{-}{\ChVal{\unit@defense@Df}}&%
\expandafter\ifblank\expandafter{\unit@defense@Re}{-}{\ChVal{\unit@defense@Re}}&%
\expandafter\ifblank\expandafter{\unit@defense@Arm}{\ChVal{0}}{\ChVal{\unit@defense@Arm}}&%
\expandafter\ifblank\expandafter{\unit@defense@Aeg}{}{\ChVal{\unit@defense@Aeg}}&%
\strut\expandafter\ifblank\expandafter{\unit@defenserules}{}{\alphaorderlist{\unit@defenserules}}%
\expandafter\ifblank\expandafter{\unit@defensearmour}{}{%
\expandafter\ifblank\expandafter{\unit@defenserules}{}{, }%
\alphaorderlist{\unit@defensearmour}}%
\tabularnewline%
\end{tabular}%

%%%%%%%%%%%%%%%%%%%%%%
% Offensive Characteristics
\vspace*{-7pt}%
\startcharacteristicstable{}%
\hspace*{3pt}\ChLab{\OffensiveCharacteristics{}}&%
{\ChLab{\AttackValueInitials}}&%
{\ChLab{\OffensiveSkillInitials}}&%
{\ChLab{\StrengthInitials}}& %
{\ChLab{\ArmourPenetrationInitials}}&%
{\ChLab{\AgilityInitials}}&%
\tabularnewline%
\togglefalse{printoffensename}% reset
\expandafter\ifblank\expandafter{\unit@forceoffensenameprint}{}{\toggletrue{printoffensename}}%
\expandafter\ifblank\expandafter{\unit@offensenameB}{}{\toggletrue{printoffensename}}%
\expandafter\ifblank\expandafter{\unit@offensenameI}{}{\toggletrue{printoffensename}}%
\iftoggle{printoffensename}{%
	\nameindent\unit@offensename{}%
}{}%
&%
\expandafter\ifblank\expandafter{\unit@offense@At}{}{\ChVal{\unit@offense@At}}&%
\expandafter\ifblank\expandafter{\unit@offense@Of}{}{\ChVal{\unit@offense@Of}}&%
\expandafter\ifblank\expandafter{\unit@offense@St}{}{\ChVal{\unit@offense@St}}&%
\expandafter\ifblank\expandafter{\unit@offense@AP}{}{\ChVal{\unit@offense@AP}}&% TO-DO Remove 0 as default value in favour of nothing.
\expandafter\ifblank\expandafter{\unit@offense@Ag}{}{\ChVal{\unit@offense@Ag}}&%
\strut\expandafter\ifblank\expandafter{\unit@offenserules}{}{\alphaorderlist{\unit@offenserules}}%
\expandafter\ifblank\expandafter{\unit@offenseweapons}{}{%
\expandafter\ifblank\expandafter{\unit@offenserules}{}{, }%
\alphaorderlist{\unit@offenseweapons}}%
\tabularnewline%
%
\expandafter\ifblank\expandafter{\unit@offensenameB}{}{%
\nameindent\unit@offensenameB{}&%
\expandafter\ifblank\expandafter{\unit@offenseB@At}{}{\ChVal{\unit@offenseB@At}}&%
\expandafter\ifblank\expandafter{\unit@offenseB@Of}{}{\ChVal{\unit@offenseB@Of}}&%
\expandafter\ifblank\expandafter{\unit@offenseB@St}{}{\ChVal{\unit@offenseB@St}}&%
\expandafter\ifblank\expandafter{\unit@offenseB@AP}{}{\ChVal{\unit@offenseB@AP}}&%
\expandafter\ifblank\expandafter{\unit@offenseB@Ag}{}{\ChVal{\unit@offenseB@Ag}}&%
\strut\expandafter\ifblank\expandafter{\unit@offenserulesB}{}{\alphaorderlist{\unit@offenserulesB}}%
\expandafter\ifblank\expandafter{\unit@offenseweaponsB}{}{%
\expandafter\ifblank\expandafter{\unit@offenserulesB}{}{, }%
\alphaorderlist{\unit@offenseweaponsB}}%
\tabularnewline%
}%
%
\expandafter\ifblank\expandafter{\unit@offensenameC}{}{%
\nameindent\unit@offensenameC{}&%
\expandafter\ifblank\expandafter{\unit@offenseC@At}{}{\ChVal{\unit@offenseC@At}}&%
\expandafter\ifblank\expandafter{\unit@offenseC@Of}{}{\ChVal{\unit@offenseC@Of}}&%
\expandafter\ifblank\expandafter{\unit@offenseC@St}{}{\ChVal{\unit@offenseC@St}}&%
\expandafter\ifblank\expandafter{\unit@offenseC@AP}{}{\ChVal{\unit@offenseC@AP}}&%
\expandafter\ifblank\expandafter{\unit@offenseC@Ag}{}{\ChVal{\unit@offenseC@Ag}}&%
\strut\expandafter\ifblank\expandafter{\unit@offenserulesC}{}{\alphaorderlist{\unit@offenserulesC}}%
\expandafter\ifblank\expandafter{\unit@offenseweaponsC}{}{%
\expandafter\ifblank\expandafter{\unit@offenserulesC}{}{, }%
\alphaorderlist{\unit@offenseweaponsC}}%
\tabularnewline%
}%
%
\expandafter\ifblank\expandafter{\unit@offensenameI}{}{%
\nameindent\unit@offensenameI{}&%
&%
&%
\expandafter\ifblank\expandafter{\unit@offenseI@St}{}{\ChVal{\unit@offenseI@St}}&%
\expandafter\ifblank\expandafter{\unit@offenseI@AP}{}{\ChVal{\unit@offenseI@AP}}&%
\expandafter\ifblank\expandafter{\unit@offenseI@Ag}{}{\ChVal{\unit@offenseI@Ag}}&%
\strut\expandafter\ifblank\expandafter{\unit@offenserulesI}{}{\alphaorderlist{\unit@offenserulesI}}%
\expandafter\ifblank\expandafter{\unit@offenseweaponsI}{}{%
\expandafter\ifblank\expandafter{\unit@offenserulesI}{}{, }%
\alphaorderlist{\unit@offenseweaponsI}}%
\tabularnewline%
}%
\end{tabular}\newline%
\vspace*{-8pt}\strut% Fixing the space after the characteristics table (else there is a bug when there is multiple offense lines)

%
%%%%%%%%%%%%%%%%%%%%%%
% Assessing the balance of the columns to see if we should put some frames outside of the two column layout
%%%%%%%%%%%%%%%%%%%%%%
% Which frames are defined?
\expandafter\ifblank\expandafter{\unit@options}{}{\toggletrue{thereisoptions}}%
\expandafter\ifblank\expandafter{\unit@explicitoptions}{}{\toggletrue{thereisoptions}}%
\expandafter\ifblank\expandafter{\unit@magic}{}{\toggletrue{thereismagic}}%
\expandafter\ifblank\expandafter{\unit@paths}{}{\toggletrue{thereismagic}}%
\expandafter\ifblank\expandafter{\unit@wizardconclave}{}{\toggletrue{thereiswizardconclave}}%
\expandafter\ifblank\expandafter{\unit@mounts}{}{\toggletrue{thereismounts}}%
\expandafter\ifblank\expandafter{\unit@commandgroup}{}{\toggletrue{thereiscommandgroup}}%
\expandafter\ifblank\expandafter{\unit@modelrulesdef}{}{\toggletrue{thereismodelrulesdef}}%
\expandafter\ifblank\expandafter{\unit@optionalmodelrulesdef}{}{\toggletrue{thereisoptionalmodelrulesdef}}%
% Are there any non rules-def frames? If there is only one, is it options?
\setcounter{numberofnonrulesdefframes}{0}% reset
\iftoggle{thereismagic}{\stepcounter{numberofnonrulesdefframes}}{}%
\iftoggle{thereiswizardconclave}{\stepcounter{numberofnonrulesdefframes}}{}%
\iftoggle{thereismounts}{\stepcounter{numberofnonrulesdefframes}}{}%
\iftoggle{thereiscommandgroup}{\stepcounter{numberofnonrulesdefframes}}{}%
\iftoggle{thereisoptions}{\stepcounter{numberofnonrulesdefframes}%
	\ifnumcomp{\value{numberofnonrulesdefframes}}{=}{1}{% then there is only options defined
		\toggletrue{optionsistheonlynonrulesdefframe}%
	}{}% End of \ifnumcomp
}{}% End of \iftoggle{thereisoptions}
% Is options long enough to put it out of the twocols layout?
\iftoggle{thereisoptions}{%
	\expandafter\ifblank\expandafter{\unit@options}{\toggletrue{twocolprintoptions}}{% For specific options, we don't have a way yet to count the options, so we set the two cols layout by default
	\countitemsinoptionslist{\unit@options}%
	\ifnumcomp{\value{numberofitemsinlist}}{>}{3}{\toggletrue{thereismorethanXitemsinoptions}}{}%
	\ifboolexpr{ togl {optionsistheonlynonrulesdefframe} and togl {thereismorethanXitemsinoptions}}{%
		\toggletrue{onecolprintoptions}
	}{\toggletrue{twocolprintoptions}}% End ifnumcomp
	}%
}{}% End of \iftoggle{thereisoptions}
% How do we handle the modelrulesdef now?
\ifboolexpr{ test {\ifnumcomp{\value{numberofnonrulesdefframes}}{=}{0}}
	or
	(test {\ifnumcomp{\value{numberofnonrulesdefframes}}{=}{1}} and togl {onecolprintoptions})
}{% Then we want rules on a one col layout
	\iftoggle{thereismodelrulesdef}{\toggletrue{onecolprintmodelrulesdef}}{}%
	\iftoggle{thereisoptionalmodelrulesdef}{\toggletrue{onecolprintoptionalmodelrulesdef}}{}%
}{% Else we want them in twocols layout
	\iftoggle{thereismodelrulesdef}{\toggletrue{twocolprintmodelrulesdef}}{}%
	\iftoggle{thereisoptionalmodelrulesdef}{\toggletrue{twocolprintoptionalmodelrulesdef}}{}%
}% End of \ifboolexpr
% How do we handle the last frames?
\setcounter{numberoftwocolframes}{0}%
\iftoggle{thereismagic}{\stepcounter{numberoftwocolframes}\toggletrue{twocolprintmagic}}{}%
\iftoggle{thereiswizardconclave}{\stepcounter{numberoftwocolframes}\toggletrue{twocolprintwizardconclave}}{}%
\iftoggle{thereismounts}{\stepcounter{numberoftwocolframes}\toggletrue{twocolprintmounts}}{}%
\iftoggle{twocolprintoptions}{\stepcounter{numberoftwocolframes}}{}%
\iftoggle{thereiscommandgroup}{%
	\ifnumcomp{\value{numberoftwocolframes}}{>}{0}{%
		\toggletrue{twocolprintcommandgroup}%
	}{%
		\countitemsinoptionslist{\unit@commandgroup}%
		\ifnumcomp{\value{numberofitemsinlist}}{>}{1}{%
				\toggletrue{onecolprintcommandgroup}%
		}{%
				\toggletrue{twocolprintcommandgroup}%		
		}%
	}%
}{}%
% Is there at least one thing to put in the big rules frame?
\ifboolexpr{ test {\ifnumcomp{\value{numberofnonrulesdefframes}}{>}{0}}
	or togl {thereismodelrulesdef}
	or togl {thereisoptionalmodelrulesdef}
}{\toggletrue{thereisatleastoneframe}}{}%

%%%%%%%%%%%%%%%%%%%%%%
% If any toggles have to be manually changed
\unit@toggles{}%
%%%%%%%%%%%%%%%%%%%%%%
% Rules frame
% We print the frame if and only if there is something to put inside
\iftoggle{thereisatleastoneframe}{%
%%%%%%%%%%%%%%%%%%%%%%
% Two columns frames, we print it if there is something to put in the frame
\ifboolexpr{togl{twocolprintmodelrulesdef} or togl{twocolprintoptions} or togl{twocolprintmagic} or togl{twocolprintwizardconclave} or togl{twocolprintmounts} or togl{twocolprintcommandgroup} or togl{twocolprintoptionalmodelrulesdef}}{%
\setlength{\columnsep}{10pt}%
\setlength{\multicolsep}{0pt}%
\raggedcolumns%
\begin{multicols}{2}%
\iftoggle{twocolprintmodelrulesdef}{\strut\modelrulesdef{\unit@modelrulesdef}}{}%
\iftoggle{twocolprintmagic}{\strut\magic{\unit@magic}{\unit@paths}}{}%
\iftoggle{twocolprintoptions}{%
	\expandafter\ifblank\expandafter{\unit@options}{%
		\strut\explicitoptions{\unit@explicitoptions}%	
	}{%
		\strut\options{\unit@options}%
	}%
}{}%
\iftoggle{twocolprintwizardconclave}{\strut\printwizardconclave{\unit@wizardconclave}}{}%
\iftoggle{twocolprintmounts}{\strut\mounts{\unit@mounts}}{}%
\iftoggle{twocolprintcommandgroup}{\strut\commandgroup{\unit@commandgroup}}{}%
\iftoggle{twocolprintoptionalmodelrulesdef}{\strut\optionalmodelrulesdef{\unit@optionalmodelrulesdef}}{}%
\end{multicols}%
% Additional space if there is a single column rule after
\ifboolexpr{ togl {onecolprintmodelrulesdef}
	or togl {onecolprintoptions}
	or togl {onecolprintmounts}
	or togl {onecolprintcommandgroup}
	or togl {onecolprintoptionalmodelrulesdef}
}{\vspace*{8pt}}{}%
}{}%
%%%%%%%%%%%%%%%%%%%%%%
% Single column
\ifboolexpr{ togl {onecolprintmodelrulesdef}
	or togl {onecolprintoptions}
	or togl {onecolprintmounts}
	or togl {onecolprintcommandgroup}
	or togl {onecolprintoptionalmodelrulesdef}
}{%
\vspace*{-5pt}%
\iftoggle{onecolprintmodelrulesdef}{\strut\modelrulesdef{\unit@modelrulesdef}}{}%
\iftoggle{onecolprintoptions}{%
	\expandafter\ifblank\expandafter{\unit@options}{%
		\strut\explicitoptionstwocols{\unit@explicitoptions}%	
	}{%
		\strut\optionstwocols{\unit@options}%
	}%
}{}%
\iftoggle{onecolprintmounts}{\strut\mountstwocols{\unit@mounts}}{}%
\iftoggle{onecolprintcommandgroup}{\strut\commandgrouptwocols{\unit@commandgroup}}{}%
\iftoggle{onecolprintoptionalmodelrulesdef}{\strut\optionalmodelrulesdef{\unit@optionalmodelrulesdef}}{}%
}{}%
}{}% END of there is at least one frame

%%%%%%%%%%%%%%%%%%%%%%
% Additional stuff
\expandafter\ifblank\expandafter{\unit@endtext}{}{\unit@endtext\vspace*{-7pt}}%

\vspace*{-3pt}%
\hfill{\verysmallfontsize\textcolor{white}{d}} % Else footer goes wild for some reason with ocgcolorlinks option
\end{minipage}%
\vspace{5pt}%


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%% Filling the profiles database for the QRS
\DTLnewrow{profiles}%
\expandafter\dtbfillunitname\expandafter{\unit@name}%
\expandafter\dtbfillunitQRSname\expandafter{\unit@QRSname}%
\expandafter\dtbfillhypertag\expandafter{\unithypertag}%
\edef\categorynumberstring{\arabic{categorynumber}}%
\expandafter\dtbfillcategorytag\expandafter{\categorynumberstring}%
\expandafter\dtbfillsize\expandafter{\unit@size}%
\expandafter\dtbfilltype\expandafter{\unit@type}%
\expandafter\dtbfillscoring\expandafter{\unit@scoring}%
%
\expandafter\dtbfillglobal@Ad\expandafter{\unit@global@Ad}%
\expandafter\dtbfillglobal@Ma\expandafter{\unit@global@Ma}%
\expandafter\dtbfillglobal@Adfly\expandafter{\unit@global@Adfly}%
\expandafter\dtbfillglobal@Mafly\expandafter{\unit@global@Mafly}%
\expandafter\dtbfillglobal@Di\expandafter{\unit@global@Di}%
%
\expandafter\dtbfillglobal@Rsr\expandafter{\unit@global@Rsr}%
\expandafter\ifblank\expandafter{\unit@global@Rsr}{}{%
	\pdfstringdef\textwithoutformatting{\unit@global@Rsr}%
	\pdfsubstitute\textwithoutformatting{ }{}%
	\dolanguagespecificsubstitute{}%
	\substitute\textwithoutformatting{\string\376}{}%
	\substitute\textwithoutformatting{\string\377}{}%
	\substitute\textwithoutformatting{\string\000}{}%
	\expandafter\dtbfillglobal@RsrSortLabel\expandafter{\textwithoutformatting}%
}%
\expandafter\dtbfillglobalrules\expandafter{\unit@globalrules}%
%
\expandafter\dtbfilldefense@HP\expandafter{\unit@defense@HP}%
\expandafter\dtbfilldefense@Df\expandafter{\unit@defense@Df}%
\expandafter\dtbfilldefense@Re\expandafter{\unit@defense@Re}%
\expandafter\dtbfilldefense@Arm\expandafter{\unit@defense@Arm}%
\expandafter\dtbfilldefense@Aeg\expandafter{\unit@defense@Aeg}%
\expandafter\dtbfillprintAeg\expandafter{\unit@printAeg}%
\expandafter\dtbfilldefenserules\expandafter{\unit@defenserules}%
\expandafter\dtbfilldefensearmour\expandafter{\unit@defensearmour}%
%
\expandafter\dtbfilloffensename\expandafter{\unit@offensename}%
\expandafter\dtbfilloffense@Ag\expandafter{\unit@offense@Ag}%
\expandafter\dtbfilloffense@At\expandafter{\unit@offense@At}%
\expandafter\dtbfilloffense@Of\expandafter{\unit@offense@Of}%
\expandafter\dtbfilloffense@St\expandafter{\unit@offense@St}%
\expandafter\dtbfilloffense@AP\expandafter{\unit@offense@AP}%
\expandafter\dtbfilloffenserules\expandafter{\unit@offenserules}%
\expandafter\dtbfilloffenseweapons\expandafter{\unit@offenseweapons}%
%
\expandafter\dtbfilloffensenameB\expandafter{\unit@offensenameB}%
\expandafter\dtbfilloffenseB@Ag\expandafter{\unit@offenseB@Ag}%
\expandafter\dtbfilloffenseB@At\expandafter{\unit@offenseB@At}%
\expandafter\dtbfilloffenseB@Of\expandafter{\unit@offenseB@Of}%
\expandafter\dtbfilloffenseB@St\expandafter{\unit@offenseB@St}%
\expandafter\dtbfilloffenseB@AP\expandafter{\unit@offenseB@AP}%
\expandafter\dtbfilloffenserulesB\expandafter{\unit@offenserulesB}%
\expandafter\dtbfilloffenseweaponsB\expandafter{\unit@offenseweaponsB}%
%
\expandafter\dtbfilloffensenameC\expandafter{\unit@offensenameC}%
\expandafter\dtbfilloffenseC@Ag\expandafter{\unit@offenseC@Ag}%
\expandafter\dtbfilloffenseC@At\expandafter{\unit@offenseC@At}%
\expandafter\dtbfilloffenseC@Of\expandafter{\unit@offenseC@Of}%
\expandafter\dtbfilloffenseC@St\expandafter{\unit@offenseC@St}%
\expandafter\dtbfilloffenseC@AP\expandafter{\unit@offenseC@AP}%
\expandafter\dtbfilloffenserulesC\expandafter{\unit@offenserulesC}%
\expandafter\dtbfilloffenseweaponsC\expandafter{\unit@offenseweaponsC}%
%
\expandafter\dtbfilloffensenameI\expandafter{\unit@offensenameI}%
\expandafter\dtbfilloffenseI@Ag\expandafter{\unit@offenseI@Ag}%
\expandafter\dtbfilloffenseI@St\expandafter{\unit@offenseI@St}%
\expandafter\dtbfilloffenseI@AP\expandafter{\unit@offenseI@AP}%
\expandafter\dtbfilloffenserulesI\expandafter{\unit@offenserulesI}%
\expandafter\dtbfilloffenseweaponsI\expandafter{\unit@offenseweaponsI}%
% End of Unit Entry
\ifdefined\thisisanarmybook%
%
\else%
\def\@minipagerestore{}%
\fi%
}% END newcommand unitentry no base size